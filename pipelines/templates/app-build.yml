parameters:
- name: platform
  type: string
  default: "ios"

steps:
  - template: ./install-node.yml
  - script: |
      echo "##vso[task.setvariable variable=VERSION;]$(node ./nodescripts/version-number.js)"
    displayName: "Get version number"
  - script: |
      echo "##vso[task.setvariable variable=BUILD_NUMBER;]$(node ./nodescripts/build-number.js)"
    displayName: "Get build number"
  - script: |
      echo "$(VERSION).$(BUILD_NUMBER)" > $(Build.ArtifactStagingDirectory)/version.txt
    displayName: "Save version number"
  - script: |
      echo "##vso[build.updatebuildnumber]$(VERSION).$(BUILD_NUMBER)"
    displayName: "Update Azure Buildnumber"
  - script: |
      echo "##vso[task.setvariable variable=RELEASE]${{ parameters.platform }}@$(VERSION).$(BUILD_NUMBER)"
      export SENTRY_RELEASE=$(RELEASE)
      export SENTRY_DIST=$(BUILD_NUMBER)
    displayName: "Set release and dist env vars for Sentry source map upload"
  - template: ./copy-files.yml
    parameters: 
      platform: ${{ parameters.platform }}
  - template: ./copy-android-files.yml
    parameters: 
      condition: eq('${{ parameters.platform }}', 'android')
  - template: ./copy-ios-files.yml
    parameters: 
      condition: eq('${{ parameters.platform }}', 'ios')
  - script: npm ci
    displayName: 'Install node dependencies'
  - script: npm run lint
    displayName: 'Run lint'
  - script: npm run typescript
    displayName: 'Run typescript checks'
  - script: npm run test
    displayName: 'Run unit tests'
  - task: JavaToolInstaller@0
    inputs:
      versionSpec: '11'
      jdkArchitectureOption: 'x64'
      jdkSourceOption: 'PreInstalled'
    condition: eq('${{ parameters.platform }}', 'android')
  - script: |
      bundle install
      bundle exec fastlane buildApps
    displayName: "Build ${{ parameters.platform }}"
    workingDirectory: ${{ parameters.platform }}
    env:
      VERSION: $(VERSION)
      BUILD_NUMBER: $(BUILD_NUMBER)
  - template: ./copy-generic-artifacts.yml
    parameters:
      platform: ${{ parameters.platform }}
  - template: ./copy-android-artifacts.yml
    parameters: 
      condition: eq('${{ parameters.platform }}', 'android')
  - template: ./copy-ios-artifacts.yml
    parameters: 
      condition: eq('${{ parameters.platform }}', 'ios')
  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: $(Build.ArtifactStagingDirectory)
      artifactName: ${{ parameters.platform }}-build
